-- Sample benchmark for BeepBeep 3

-- Assemble the closing price of stocks "1" and "2" for the same
-- timestamp in a single tuple.

CREATE VIEW ThePrices AS
 SELECT T1.closingPrice AS p1, T2.closingPrice AS p2, T1.timestamp AS timestamp
 FROM stocks AS t1, stocks AS t2
 WHERE t1.timestamp = t2.timestamp;

CREATE VIEW q1 AS
  SELECT timestamp FROM ThePrices WHERE p2 < 2;

CREATE VIEW not_q2 AS
  SELECT timestamp FROM ThePrices WHERE p1 <= p2;

CREATE VIEW u_temp AS
  SELECT MAX(TA.timestamp) AS n1, TB.timestamp AS n2
  FROM not_q2 AS TA JOIN q1 AS TB
  WHERE TA.timestamp < TB.timestamp GROUP BY TB.timestamp;

CREATE VIEW next_until AS
  SELECT T1.timestamp - 1 AS timestamp 
  FROM ThePrices AS T1, JOIN u_temp AS T2
  WHERE T1.timestamp > T2.n1 AND T1.timestamp <= T2.n2;

SELECT COUNT(*) FROM q1 AS T0, next_until AS T3
  WHERE T0.timestamp = T3.timestamp;
